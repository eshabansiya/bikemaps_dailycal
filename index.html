<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Points on a map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      .title-bar {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        font-size: 16px;
        font-weight: bold;
        z-index: 3;
        border-radius: 4px;
      }

      #controls-container {
        position: absolute;
        top: 2%;
        right: 1%;
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 3;
        border-radius: 3%;
        padding: 8px;
        width: 250px;
        font-size: 13px;
      }

      #toggle-controls {
        display: flex;
        flex-direction: column;
        margin-bottom: 4%;
      }

      #toggle-controls button {
        margin-bottom: 5px;
        border: none;
        padding: 10px;
        cursor: pointer;
        background: #e6f4ea;
        color: #117833;
        border-radius: 4px;
        font-weight: bold;
        text-align: center;
      }

      #toggle-controls button.active {
        background: #117833;
        color: white;
      }

      .year-selector {
        display: flex;
        flex-direction: column;
        gap: 7px;
      }

      .year-selector button {
        border: none;
        padding: 6px;
        font-size: 12px;
        cursor: pointer;
        color: black;
        border-radius: 4px;
        padding: 5px;
        height: 30px;
      }

      .year-selector button[data-year="2019"] { background: #d4abab; }
      .year-selector button[data-year="2020"] { background: #ffe5ba; }
      .year-selector button[data-year="2021"] { background: #fcac73; }
      .year-selector button[data-year="2022"] { background: #f4854d; }
      .year-selector button[data-year="2023"] { background: #e5653d; }
      .year-selector button[data-year="2024"] { background: #bd5050; }
      .year-selector button[data-year="2025"] { background: #aa3a45; }

      .year-selector button:hover {
        filter: brightness(90%);
      }

      .year-selector button.active {
        color: white;
        font-weight: bold;
        border: 2px solid black;
      }

      #legend {
        position: absolute;
        top: 2%;
        left: 2%;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 3%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        padding: 10px;
        line-height: 18px;
        width: 220px;
        z-index: 2;
      }

      .legend-key {
        display: inline-block;
        width: 10px;
        height: 10px;
        margin-right: 5px;
      }

      .data-info {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.95);
        text-align: center;
        padding: 8px;
        font-size: 13px;
        border-top: 1px solid #ccc;
        z-index: 2;
      }

      .mapboxgl-popup.custom-popup {
        width: auto;
        max-height: 20px;
        font-family: Arial, sans-serif;
        font-size: 13px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }

      .mapboxgl-popup.custom-popup p {
        margin: 0;
        color: #333;
        font-size: 12px;
      }

      .mapboxgl-popup.custom-popup h3 {
        margin: 0 0 1px;
        font-size: 14px;
        color: #aa3a45;
      }

      #stats-box {
        position: absolute;
        top: 26%; 
        left: 2%;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        padding: 10px;
        width: 220px;
        z-index: 2;
        font-size: 14px;
      }

      #stats-box h4 {
        margin: 0 0 8px;
        font-size: 14px;
        text-align: center;
      }

    </style>
  </head>
  <body>
    <div class="title-bar">Pedestrian and Biking Crashes in Berkeley as Road Improvements Continue</div>
    <div id="map"></div>

    <div id="controls-container">
      <div id="toggle-controls">
        <button id="toggle-bicycle" class="active">Show Bicycle Crashes</button>
        <button id="toggle-pedestrian" class="active">Show Pedestrian Crashes</button>
      </div>

      <div class="year-selector" id="year-selector">
        <button data-year="2019">2019</button>
        <button data-year="2020">2020</button>
        <button data-year="2021">2021</button>
        <button data-year="2022">2022</button>
        <button data-year="2023">2023</button>
        <button data-year="2024">2024</button>
        <button data-year="2025">2025</button>
        <p>Road work in 2025 is in-progress or planned.</p>
      </div>
    </div>

    <div id="legend"></div>

    <div id="stats-box">
      <h4>Crash Statistics</h4>
      <canvas id="crashChart" width="200" height="120"></canvas>
    </div>

    <div class="data-info">
      Chart: Esha Bansiya/The Daily Californian | Data source:
      <a href="https://tims.berkeley.edu/" target="_blank" style="color:#0077cc; text-decoration:underline;">
        Transportation Injury Mapping System
      </a>
      | Crash Data from 2023-2025 is provisional and subject to change. | 2025 data is until March
    </div>

    <script>
      mapboxgl.accessToken = 'pk.eyJ1IjoiZXNoYWJhbnNpeWEiLCJhIjoiY21kZ2s3cDQ5MHI2eTJxb2U0N3M2YmF6eCJ9.lECv9CCR7GA1SCyPAP3gXw';
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/eshabansiya/cmdy2jbbo00cr01re9vc5adw2',
        center: [-122.2730, 37.8715],
        zoom: 13
      });

      map.on('load', () => {
        const layers = ['Biking Crash', 'Pedestrian Crash', 'Fatality', 'Road Improvements'];
        const colors = ['#0b6b13', '#0f77d2', '#b140b5', '#f4854d'];

        const legend = document.getElementById('legend');
        legend.innerHTML = '';

        layers.forEach((layer, i) => {
          const color = colors[i];
          const item = document.createElement('div');
          item.style.display = 'flex';
          item.style.alignItems = 'center';
          item.style.marginBottom = '4px';

          const key = document.createElement('span');
          key.className = 'legend-key';
          key.style.width = '15px';
          key.style.marginRight = '5px';

          if (layer === 'Fatality') {
            key.style.backgroundColor = 'white';
            key.style.border = `2px solid ${color}`;
            key.style.borderRadius = '50%';
            key.style.height = '15px';
          } else if (layer === 'Road Improvements') {
            key.style.backgroundColor = color;
            key.style.height = '6px';
          } else {
            key.style.backgroundColor = color;
            key.style.borderRadius = '50%';
            key.style.height = '15px';
          }

          const value = document.createElement('span');
          value.innerHTML = layer;

          item.appendChild(key);
          item.appendChild(value);
          legend.appendChild(item);
        });

        const note = document.createElement('p');
        note.style.fontSize = '12px';
        note.style.marginTop = '8px';
        note.innerText = "Road improvements are colored by the year they were added.";
        legend.appendChild(note);

        const yearButtons = document.querySelectorAll('#year-selector button');
        let selectedYear = 2019;

        map.setFilter('allcrashes3-8p8tg3', ['==', 'ACCIDENT_YEAR', selectedYear]);
        map.setFilter('map-2-1wq16q', ['==', 'Year', selectedYear]);
        document.querySelector(`#year-selector button[data-year="${selectedYear}"]`).classList.add('active');

        yearButtons.forEach(button => {
          button.addEventListener('click', () => {
            yearButtons.forEach(b => b.classList.remove('active'));
            button.classList.add('active');
            selectedYear = parseInt(button.getAttribute('data-year'));
            map.setFilter('allcrashes3-8p8tg3', ['==', 'ACCIDENT_YEAR', selectedYear]);
            map.setFilter('map-2-1wq16q', ['<=', 'Year', selectedYear]);
            updateLayerVisibility();
          });
        });

        let isBicycleVisible = true;
        let isPedestrianVisible = true;

        const bicycleButton = document.getElementById('toggle-bicycle');
        const pedestrianButton = document.getElementById('toggle-pedestrian');

        function updateLayerVisibility() {
          map.setFilter('allcrashes3-8p8tg3', [
            "all",
            ...(isBicycleVisible ? [] : [["!=", "BICYCLE_ACCIDENT", "Y"]]),
            ...(isPedestrianVisible ? [] : [["!=", "PEDESTRIAN_ACCIDENT", "Y"]]),
            ["==", "ACCIDENT_YEAR", selectedYear]
          ]);
        }

        bicycleButton.addEventListener('click', () => {
          isBicycleVisible = !isBicycleVisible;
          bicycleButton.classList.toggle('active', isBicycleVisible);
          updateLayerVisibility();
        });

        pedestrianButton.addEventListener('click', () => {
          isPedestrianVisible = !isPedestrianVisible;
          pedestrianButton.classList.toggle('active', isPedestrianVisible);
          updateLayerVisibility();
        });

        updateLayerVisibility();

        let crashChart;

        function updateCrashStats() {
          const features = map.querySourceFeatures('composite', { sourceLayer: 'allcrashes3-8p8tg3' });

          let pedestrianCount = 0;
          let bicycleCount = 0;
          let fatalCount = 0;

          features.forEach(f => {
            if (f.properties.ACCIDENT_YEAR == selectedYear) {
              if (f.properties.PEDESTRIAN_ACCIDENT === 'Y') pedestrianCount++;
              if (f.properties.BICYCLE_ACCIDENT === 'Y') bicycleCount++;
              if (f.properties.COLLISION_SEVERITY === 'Fatal' || f.properties.COLLISION_SEVERITY === 'Severe Injury') fatalCount++;
            }
          });

          const data = [pedestrianCount, bicycleCount, fatalCount];

          if (crashChart) {
            crashChart.data.datasets[0].data = data;
            crashChart.update();
          } else {
            const ctx = document.getElementById('crashChart').getContext('2d');
            crashChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: ['Pedestrian', 'Bicycle', 'Fatal or Severe'],
                datasets: [{
                  label: 'Crashes',
                  data: data,
                  backgroundColor: ['#0f77d2', '#0b6b13', '#b140b5']
                }]
              },
              options: {
                plugins: { legend: { display: false } },
                scales: {
                  y: { max: 150, ticks: { stepSize: 10 } },
                }
              }
            });
          }
        }

        updateCrashStats();

        yearButtons.forEach(button => {
          button.addEventListener('click', () => {
            updateCrashStats();
          });
        });

      });

      map.on('click', 'map-2-1wq16q', (event) => {
        const roadFeature = event.features[0];
        new mapboxgl.Popup({ offset: [0, -15], className: 'custom-popup' })
          .setLngLat(event.lngLat)
          .setHTML(`
            <h3>Project: ${roadFeature.properties.Project}</h3>
            <p>Year: ${roadFeature.properties.Year}</p>
            <p>Vision Zero: ${roadFeature.properties["Vision Zero"] || 'No'}</p>
            <p>Work Done: ${roadFeature.properties.Notes}</p>
          `)
          .addTo(map);
      });

      map.on('click', 'allcrashes3-8p8tg3', (event) => {
        const pcfViolations = {
          "00": "Unknown",
          "01": "Driving or Bicycling Under the Influence of Alcohol or Drug",
          "03": "Unsafe Speed",
          "04": "Following Too Closely",
          "05": "Wrong Side of Road",
          "06": "Improper Passing",
          "07": "Unsafe Lane Change",
          "08": "Improper Turning",
          "09": "Automobile Right of Way",
          "10": "Pedestrian Right of Way",
          "11": "Pedestrian Violation",
          "12": "Traffic Signals and Signs",
          "14": "Lights",
          "17": "Other Hazardous Violation",
          "18": "Other Than Driver (or Pedestrian)",
          "21": "Unsafe Starting or Backing",
          "22": "Other Improper Driving"
        };

        const feature = event.features[0];
        const bikeCrash = feature.properties.BICYCLE_ACCIDENT ? `<p>Bicycle Crash: ${feature.properties.BICYCLE_ACCIDENT}</p>` : '';
        const pedestrianCrash = feature.properties.PEDESTRIAN_ACCIDENT ? `<p>Pedestrian Crash: ${feature.properties.PEDESTRIAN_ACCIDENT}</p>` : '';
        const pcfCode = feature.properties.PCF_VIOL_CATEGORY;
        const pcfDescription = pcfViolations[pcfCode] || "Unknown";

        new mapboxgl.Popup({ offset: [0, -15], className: 'custom-popup'})
          .setLngLat(feature.geometry.coordinates)
          .setHTML(`<h3>Case ID: ${feature.properties.CASE_ID}</h3>
            <p>Crash Date: ${feature.properties.COLLISION_DATE}</p>
            <p>Crash Severity: ${feature.properties.COLLISION_SEVERITY}</p>
            <p>PCF Violation: ${pcfDescription}</p>
            ${bikeCrash}${pedestrianCrash}`)
          .addTo(map);
      });
    </script>
  </body>
</html>
